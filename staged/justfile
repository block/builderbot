# Staged - Git Diff Viewer
# Run `just install` once after cloning, then `just dev` to start.

# ============================================================================
# Development
# ============================================================================

# Run the app in development mode (optionally point to another repo)
dev repo="":
    #!/usr/bin/env bash
    set -euo pipefail

    # Pick a free port so multiple worktrees can run simultaneously
    VITE_PORT=$(python3 -c 'import socket; s=socket.socket(); s.bind(("",0)); print(s.getsockname()[1]); s.close()')
    export VITE_PORT
    TAURI_CONFIG="{\"build\":{\"devUrl\":\"http://localhost:${VITE_PORT}\"}}"

    # In worktrees, generate a labeled icon so you can tell instances apart
    if git rev-parse --is-inside-work-tree &>/dev/null; then
        GIT_DIR=$(git rev-parse --git-dir)
        if [[ "$GIT_DIR" == *".git/worktrees/"* ]]; then
            BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
            WORKTREE_LABEL="${BRANCH_NAME##*/}"

            ICON_DIR="$(pwd)/src-tauri/target/dev-icons"
            mkdir -p "$ICON_DIR"
            DEV_ICON="$ICON_DIR/icon.icns"

            if swift scripts/generate-dev-icon.swift src-tauri/icons/icon.icns "$DEV_ICON" "$WORKTREE_LABEL"; then
                echo "ðŸŒ³ Worktree: ${WORKTREE_LABEL}"
                TAURI_CONFIG="{\"build\":{\"devUrl\":\"http://localhost:${VITE_PORT}\"},\"bundle\":{\"icon\":[\"$DEV_ICON\"]}}"
            fi
        fi
    fi

    echo "Starting on port ${VITE_PORT}"
    {{ if repo != "" { "export STAGED_REPO=" + repo } else { "" } }}
    npx tauri dev --config "$TAURI_CONFIG"

# Build the app for production
build:
    npm run tauri:build

# ============================================================================
# Code Quality
# ============================================================================

# Auto-format all code
fmt:
    cd src-tauri && cargo fmt
    npx prettier --write "src/**/*.{ts,svelte,css,html}"

# Verify formatting without modifying files (used by CI/hooks)
fmt-check:
    cd src-tauri && cargo fmt --check
    npx prettier --check "src/**/*.{ts,svelte,css,html}"

# Lint Rust code with clippy
lint:
    cd src-tauri && cargo clippy -- -D warnings

# Type-check frontend (Svelte + TypeScript) and backend (Rust)
typecheck:
    npm run check
    cd src-tauri && cargo check

# Format, then verify everything passes â€” run before pushing
check-all: fmt lint typecheck

# Verify everything without modifying files â€” for CI
ci: fmt-check lint typecheck

# ============================================================================
# Setup & Maintenance
# ============================================================================

# First-time setup: install all dependencies and git hooks
install:
    npm install
    cd src-tauri && cargo fetch
    lefthook install

# Delete all build artifacts and dependencies
clean:
    rm -rf dist node_modules
    rm -rf src-tauri/target
